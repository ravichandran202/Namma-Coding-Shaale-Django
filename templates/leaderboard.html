{% extends 'base.html' %}
{% load static %}

{% block title %}My Courses & Leaderboard | ನಮ್ಮ CODING ಶಾಲೆ{% endblock %}

{% block extra_css %}
<style>
    :root {
        --border: rgba(0, 0, 0, 0.08);
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        --border-radius: 12px;
        --section-padding: 8rem 0;
        --container-max-width: 1200px;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    .display-font {
        font-family: 'Plus Jakarta Sans', sans-serif;
        font-weight: 700;
        letter-spacing: -0.02em;
    }

    .text-serif {
        font-family: 'Plus Jakarta Sans', sans-serif;
    }

    .text-sans {
        font-family: 'Inter', sans-serif;
    }

    .text-uppercase {
        letter-spacing: 0.1em;
    }

    /* Section Styling */
    .section {
        padding: var(--section-padding);
        padding-bottom: 1rem;
    }

    .section-title {
        font-size: 2rem;
        margin-bottom: 3rem;
        text-align: center;
        position: relative;
    }

    .section-title:after {
        content: '';
        display: block;
        width: 80px;
        height: 4px;
        background: var(--primary);
        margin: 1.5rem auto;
        border-radius: 2px;
    }

    /* Leaderboard Toggle */
    .leaderboard-toggle-container {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
    }

    .leaderboard-toggle {
        position: relative;
        display: flex;
        background: white;
        border-radius: 50px;
        padding: 4px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
    }

    .toggle-bg-pill {
        position: absolute;
        top: 4px;
        left: 0;
        height: calc(100% - 8px);
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-radius: 50px;
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), width 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        z-index: 0;
    }

    .toggle-btn {
        position: relative;
        z-index: 1;
        flex: 1;
        padding: 0.75rem 2rem;
        border: none;
        background: transparent;
        cursor: pointer;
        font-weight: 600;
        border-radius: 50px;
        transition: color 0.3s ease;
        color: var(--gray);
        min-width: 120px;
    }

    .toggle-btn.active {
        color: white !important;
    }

    .lb-content {
        display: none;
        animation: fadeIn 0.5s ease;
    }

    .lb-content.active {
        display: block;
    }

    /* Podium */
    .podium-wrapper {
        display: flex;
        justify-content: center;
        align-items: flex-end;
        gap: 1rem;
        margin: 3rem auto 4rem;
        max-width: 700px;
    }

    .podium-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
    }

    .podium-item.rank-1 {
        order: 2;
    }

    .podium-item.rank-2 {
        order: 1;
    }

    .podium-item.rank-3 {
        order: 3;
    }

    .podium-avatar-box {
        position: relative;
        z-index: 1;
    }

    .crown-icon {
        position: absolute;
        top: -25px;
        left: 50%;
        transform: translateX(-50%) rotate(-20deg);
        color: #FFD700;
        font-size: 1.8rem;
        animation: float 2.5s ease-in-out infinite;
        filter: drop-shadow(0 2px 4px rgba(255, 215, 0, 0.4));
    }

    @keyframes float {

        0%,
        100% {
            transform: translateX(-50%) translateY(0) rotate(-20deg);
        }

        50% {
            transform: translateX(-50%) translateY(-8px) rotate(-20deg);
        }
    }

    .podium-avatar {
        width: 70px;
        height: 70px;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: #2563eb;
        font-weight: 700;
        border: 3px solid white;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }

    .podium-item.rank-1 .podium-avatar {
        width: 100px;
        height: 100px;
        font-size: 2.5rem;
        background: linear-gradient(135deg, #FFFACD 0%, #FFD700 100%);
        color: #B8860B;
        border: 4px solid #FFD700;
        box-shadow: 0 8px 24px rgba(255, 215, 0, 0.4);
    }

    .podium-item.rank-2 .podium-avatar {
        background: linear-gradient(135deg, #F8F9FA 0%, #E9ECEF 100%);
        color: #6c757d;
        border: 3px solid #C0C0C0;
        box-shadow: 0 4px 12px rgba(192, 192, 192, 0.3);
    }

    .podium-item.rank-3 .podium-avatar {
        background: linear-gradient(135deg, #FFF5EE 0%, #FFE4C4 100%);
        color: #A0522D;
        border: 3px solid #CD7F32;
        box-shadow: 0 4px 12px rgba(205, 127, 50, 0.3);
    }

    .podium-name {
        font-weight: 700;
        font-size: 1.1rem;
        color: var(--dark);
        margin-bottom: 4px;
    }

    .podium-points {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--primary);
        background: rgba(37, 99, 235, 0.08);
        padding: 2px 10px;
        border-radius: 20px;
    }

    .podium-block {
        width: 100%;
        background: white;
        border-radius: 16px 16px 0 0;
        box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.03), 0 10px 10px rgba(0, 0, 0, 0.02);
        display: flex;
        justify-content: center;
        align-items: flex-end;
        padding-bottom: 15px;
        font-family: 'Plus Jakarta Sans', sans-serif;
        font-weight: 800;
        font-size: 3rem;
        opacity: 0.9;
        position: relative;
    }

    .podium-item.rank-1 .podium-block {
        height: 160px;
        background: linear-gradient(to bottom, #fff, #FFFDF0);
        color: rgba(255, 215, 0, 0.25);
        border-top: 4px solid #FFD700;
    }

    .podium-item.rank-2 .podium-block {
        height: 120px;
        background: linear-gradient(to bottom, #fff, #F8F9FA);
        color: rgba(192, 192, 192, 0.25);
        border-top: 4px solid #C0C0C0;
    }

    .podium-item.rank-3 .podium-block {
        height: 90px;
        background: linear-gradient(to bottom, #fff, #FFF5F0);
        color: rgba(205, 127, 50, 0.25);
        border-top: 4px solid #CD7F32;
    }

    /* List Card */
    .leaderboard-list-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
    }

    .list-row {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-radius: 12px;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        margin-bottom: 0.5rem;
    }

    .list-row:hover {
        background: #f8fafc;
        border-color: #e2e8f0;
        transform: translateX(5px);
    }

    .list-rank {
        width: 40px;
        text-align: center;
        font-weight: 800;
        font-size: 1.2rem;
        color: var(--gray);
        margin-right: 15px;
    }

    .list-avatar {
        width: 45px;
        height: 45px;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: #2563eb;
        font-weight: 700;
        border: 2px solid white;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
        margin-right: 15px;
    }

    .list-info {
        flex: 1;
    }

    .list-name {
        margin: 0;
        font-size: 1rem;
        font-weight: 700;
        color: var(--dark);
    }

    .list-score {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--primary);
        display: flex;
        align-items: baseline;
        gap: 4px;
    }

    .pts-badge {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--gray);
    }

    .text-gradient {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        display: inline-block;
    }

    .btn-premium {
            background: linear-gradient(135deg, var(--primary), #7c3aed);
            color: white !important;
            border: none;
            padding: 0.75rem 1.75rem;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            text-align: center;
            width: 100%;
            justify-content: center;
        }

        .btn-premium:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
            background: linear-gradient(135deg, var(--primary-dark), #6d28d9);
            color: white;
        }

     /* Premium Lock Overlay */
        .premium-lock-overlay {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(1px);
        }

        .lock-content {
            /* background: white; */
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
            pointer-events: auto;
        }

        .blurred-content {
            pointer-events: none;
            filter: blur(4px);
            user-select: none;
            overflow: hidden;
            /* max-height: 100vh; */
        }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (max-width: 768px) {
        .podium-wrapper {
            gap: 0.5rem;
            align-items: flex-end;
        }

        .podium-avatar {
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
        }

        .podium-item.rank-1 .podium-avatar {
            width: 70px;
            height: 70px;
            font-size: 2rem;
        }

        .podium-name {
            font-size: 0.8rem;
            display: none;
        }

        .podium-points {
            font-size: 0.7rem;
        }

        .list-avatar {
            margin-right: 10px;
            width: 35px;
            height: 35px;
            font-size: 0.9rem;
        }

        .list-rank {
            width: 30px;
            font-size: 1rem;
            margin-right: 8px;
        }

        .list-name {
            font-size: 0.9rem;
        }

        .list-score {
            font-size: 0.95rem;
        }

        .leaderboard-toggle-container .leaderboard-toggle {
            width: 100% !important;
            max-width: 320px !important;
        }

        .toggle-btn {
            padding: 0.5rem 0.5rem;
            min-width: 80px;
            font-size: 0.85rem;
        }
    }

    @media (max-width: 575px) {
        .section-title {
            font-size: 1.75rem;
        }
    }
</style>
{% endblock %}

{% block content %}
{% if not has_premium_course %}
<div class="premium-lock-overlay" style="border-radius: 20px;">
    <div class="lock-content text-center">
        <i class="fas fa-crown fa-4x mb-3 text-warning"></i>
        <h2 class="fw-bold text-dark">Premium Feature</h2>
        <p class="text-muted mb-4">You need to enroll in a premium course to access the global Leaderboard.</p>
        <a href="{% url 'course-catalog' %}" class="btn btn-premium px-5 py-3 rounded-pill"
            style="width: auto;">View Courses</a>
    </div>
</div>
{% endif %}

<section class="section position-relative" id="leaderboard-section" style="padding-top: 2rem; background: transparent;">
    <div class="container" style="max-width: 900px;">

        <div class="text-center mb-5">
            <span class="text-uppercase text-primary fw-bold letter-spacing-3">Top Coders</span>
            <h2 class="section-title">Leader<span class="text-gradient">board</span></h2>

            <div class="leaderboard-toggle-container">
                <div class="leaderboard-toggle" style="width: 360px; max-width: 100%;">
                    <div class="toggle-bg-pill" id="lbTogglePill"></div>
                    <button class="toggle-btn active" onclick="switchLeaderboard('weekly', this)">Weekly</button>
                    <button class="toggle-btn" onclick="switchLeaderboard('monthly', this)">Monthly</button>
                    <button class="toggle-btn" onclick="switchLeaderboard('overall', this)">Overall</button>
                </div>
            </div>
        </div>

        <div class="leaderboard-boards-wrapper {% if not has_premium_course %}blurred-content{% endif %}">

            <div id="weekly-board" class="lb-content active">
                {% if weekly_leaders %}
                <div class="podium-wrapper">
                    {% if weekly_leaders|length > 1 %}
                    {% with weekly_leaders.1 as p2 %}
                    <div class="podium-item rank-2">
                        <div class="podium-avatar-box">
                            <div class="podium-avatar">
                                {{ p2.name|first }}
                            </div>
                        </div>
                        <div class="podium-name">{{ p2.name }}</div>
                        <div class="podium-points">{{ p2.points }} pts</div>
                        <div class="podium-block">2</div>
                    </div>
                    {% endwith %}
                    {% endif %}

                    {% if weekly_leaders|length > 0 %}
                    {% with weekly_leaders.0 as p1 %}
                    <div class="podium-item rank-1">
                        <div class="podium-avatar-box">
                            <i class="fas fa-crown crown-icon"></i>
                            <div class="podium-avatar">
                                {{ p1.name|first }}
                            </div>
                        </div>
                        <div class="podium-name">{{ p1.name }}</div>
                        <div class="podium-points">{{ p1.points }} pts</div>
                        <div class="podium-block">1</div>
                    </div>
                    {% endwith %}
                    {% endif %}

                    {% if weekly_leaders|length > 2 %}
                    {% with weekly_leaders.2 as p3 %}
                    <div class="podium-item rank-3">
                        <div class="podium-avatar-box">
                            <div class="podium-avatar">
                                {{ p3.name|first }}
                            </div>
                        </div>
                        <div class="podium-name">{{ p3.name }}</div>
                        <div class="podium-points">{{ p3.points }} pts</div>
                        <div class="podium-block">3</div>
                    </div>
                    {% endwith %}
                    {% endif %}
                </div>

                <div class="leaderboard-list-card">
                    {% for user in weekly_leaders %}
                    <a href="{% url 'student_dashboard' user.username %}" style="text-decoration: none;">
                        <div class="list-row">
                            <div class="list-rank">{{ user.rank }}</div>
                            <div class="list-avatar">
                                {{ user.name|first }}
                            </div>
                            <div class="list-info">
                                <h5 class="list-name">{{ user.name }}</h5>
                            </div>
                            <div class="list-score">{{ user.points }} <span class="pts-badge">pts</span></div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5">
                    <p class="text-muted">No activity recorded yet.</p>
                </div>
                {% endif %}
            </div>

            <div id="monthly-board" class="lb-content">
                {% if monthly_leaders %}
                <div class="podium-wrapper">
                    {% if monthly_leaders|length > 1 %}
                    {% with monthly_leaders.1 as p2 %}
                    <div class="podium-item rank-2">
                        <div class="podium-avatar-box">
                            <div class="podium-avatar">
                                {{ p2.name|first }}
                            </div>
                        </div>
                        <div class="podium-name">{{ p2.name }}</div>
                        <div class="podium-points">{{ p2.points }} pts</div>
                        <div class="podium-block">2</div>
                    </div>
                    {% endwith %}
                    {% endif %}

                    {% if monthly_leaders|length > 0 %}
                    {% with monthly_leaders.0 as p1 %}
                    <div class="podium-item rank-1">
                        <div class="podium-avatar-box">
                            <i class="fas fa-crown crown-icon"></i>
                            <div class="podium-avatar">
                                {{ p1.name|first }}
                            </div>
                        </div>
                        <div class="podium-name">{{ p1.name }}</div>
                        <div class="podium-points">{{ p1.points }} pts</div>
                        <div class="podium-block">1</div>
                    </div>
                    {% endwith %}
                    {% endif %}

                    {% if monthly_leaders|length > 2 %}
                    {% with monthly_leaders.2 as p3 %}
                    <div class="podium-item rank-3">
                        <div class="podium-avatar-box">
                            <div class="podium-avatar">
                                {{ p3.name|first }}
                            </div>
                        </div>
                        <div class="podium-name">{{ p3.name }}</div>
                        <div class="podium-points">{{ p3.points }} pts</div>
                        <div class="podium-block">3</div>
                    </div>
                    {% endwith %}
                    {% endif %}
                </div>

                <div class="leaderboard-list-card">
                    {% for user in monthly_leaders %}
                    <a href="{% url 'student_dashboard' user.username %}" style="text-decoration: none;">
                        <div class="list-row">
                            <div class="list-rank">{{ user.rank }}</div>
                            <div class="list-avatar">
                                {{ user.name|first }}
                            </div>
                            <div class="list-info">
                                <h5 class="list-name">{{ user.name }}</h5>
                            </div>
                            <div class="list-score">{{ user.points }} <span class="pts-badge">pts</span></div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5">
                    <p class="text-muted">No activity recorded yet.</p>
                </div>
                {% endif %}
            </div>

            <div id="overall-board" class="lb-content">
                {% if overall_leaders %}
                <div class="podium-wrapper">
                    {% if overall_leaders|length > 1 %}
                    {% with overall_leaders.1 as p2 %}
                    <div class="podium-item rank-2">
                        <div class="podium-avatar-box">
                            <div class="podium-avatar">
                                {{ p2.name|first }}
                            </div>
                        </div>
                        <div class="podium-name">{{ p2.name }}</div>
                        <div class="podium-points">{{ p2.points }} pts</div>
                        <div class="podium-block">2</div>
                    </div>
                    {% endwith %}
                    {% endif %}

                    {% if overall_leaders|length > 0 %}
                    {% with overall_leaders.0 as p1 %}
                    <div class="podium-item rank-1">
                        <div class="podium-avatar-box">
                            <i class="fas fa-crown crown-icon"></i>
                            <div class="podium-avatar">
                                {{ p1.name|first }}
                            </div>
                        </div>
                        <div class="podium-name">{{ p1.name }}</div>
                        <div class="podium-points">{{ p1.points }} pts</div>
                        <div class="podium-block">1</div>
                    </div>
                    {% endwith %}
                    {% endif %}

                    {% if overall_leaders|length > 2 %}
                    {% with overall_leaders.2 as p3 %}
                    <div class="podium-item rank-3">
                        <div class="podium-avatar-box">
                            <div class="podium-avatar">
                                {{ p3.name|first }}
                            </div>
                        </div>
                        <div class="podium-name">{{ p3.name }}</div>
                        <div class="podium-points">{{ p3.points }} pts</div>
                        <div class="podium-block">3</div>
                    </div>
                    {% endwith %}
                    {% endif %}
                </div>

                <div class="leaderboard-list-card">
                    {% for user in overall_leaders %}
                    <a href="{% url 'student_dashboard' user.username %}" style="text-decoration: none;">
                        <div class="list-row">
                            <div class="list-rank">{{ user.rank }}</div>
                            <div class="list-avatar">
                                {{ user.name|first }}
                            </div>
                            <div class="list-info">
                                <h5 class="list-name">{{ user.name }}</h5>
                            </div>
                            <div class="list-score">{{ user.points }} <span class="pts-badge">pts</span></div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5">
                    <p class="text-muted">No activity recorded yet.</p>
                </div>
                {% endif %}
            </div> <!-- End overall-board -->

        </div> <!-- End leaderboard-boards-wrapper -->

    </div>
</section>

<div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer" style="z-index: 1055;"></div>

{% if messages %}
<div id="django-messages-data" style="display: none;">
    {% for message in messages %}
    <div data-type="{{ message.tags }}" data-msg="{{ message }}"></div>
    {% endfor %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    function updatePillPosition() {
        const activeBtn = document.querySelector('.toggle-btn.active');
        const pill = document.getElementById('lbTogglePill');
        const container = document.querySelector('.leaderboard-toggle');
        if (activeBtn && pill && container) {
            // Subtract container padding (4px) to position the pill exactly over the button
            const offset = activeBtn.offsetLeft - 4;
            pill.style.transform = `translateX(${offset}px)`;
            pill.style.width = `${activeBtn.offsetWidth}px`;
        }
    }

    function switchLeaderboard(type, btn) {
        const buttons = document.querySelectorAll('.toggle-btn');
        const boards = document.querySelectorAll('.lb-content');

        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        boards.forEach(board => board.classList.remove('active'));

        updatePillPosition();

        if (type === 'weekly') {
            document.getElementById('weekly-board').classList.add('active');
        } else if (type === 'monthly') {
            document.getElementById('monthly-board').classList.add('active');
        } else {
            document.getElementById('overall-board').classList.add('active');
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        updatePillPosition();
        window.addEventListener('resize', updatePillPosition);

        const messageData = document.getElementById('django-messages-data');
        if (messageData) {
            Array.from(messageData.children).forEach(msgDiv => {
                showToast(msgDiv.dataset.msg, msgDiv.dataset.type);
            });
        }
    });

    function showToast(message, type) {
        const toastContainer = document.getElementById('toastContainer');
        if (type === 'error') type = 'danger';
        const bgClass = { 'success': 'text-bg-success', 'danger': 'text-bg-danger', 'warning': 'text-bg-warning', 'info': 'text-bg-info' }[type] || 'text-bg-primary';
        const icon = { 'success': 'fas fa-check-circle', 'danger': 'fas fa-exclamation-circle', 'warning': 'fas fa-exclamation-triangle', 'info': 'fas fa-info-circle' }[type] || 'fas fa-bell';
        const toastHtml = `<div class="toast align-items-center ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true"><div class="d-flex"><div class="toast-body"><i class="${icon} me-2"></i> ${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div></div>`;
        const wrapper = document.createElement('div');
        wrapper.innerHTML = toastHtml;
        const toastElement = wrapper.firstElementChild;
        toastContainer.appendChild(toastElement);
        const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
        toast.show();
        toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
    }
</script>
{% endblock %}