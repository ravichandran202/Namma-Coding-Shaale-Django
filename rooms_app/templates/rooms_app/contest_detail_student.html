{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
    :root {
        --primary-bg: #eff6ff;
        --secondary-bg: #ecfdf5;
        --gray-lighter: #f1f5f9;
        --border: rgba(0, 0, 0, 0.06);
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.03);
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.06), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
        --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.08), 0 10px 10px -5px rgba(0, 0, 0, 0.03);
        --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        --radius: 16px;
        --radius-sm: 10px;
    }

    h1, h2, h3, h4, h5 {
        font-family: 'Plus Jakarta Sans', sans-serif;
        font-weight: 700;
        letter-spacing: -0.02em;
    }

    .text-gradient {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        display: inline-block;
    }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .animate-in { opacity: 0; animation: fadeInUp 0.5s ease-out forwards; }
    .delay-1 { animation-delay: 0.1s; }
    .delay-2 { animation-delay: 0.2s; }
    .delay-3 { animation-delay: 0.3s; }
    .delay-4 { animation-delay: 0.4s; }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .breadcrumb-premium a {
        color: var(--gray);
        text-decoration: none;
        font-size: 0.82rem;
        font-weight: 500;
        transition: color 0.2s;
    }

    .breadcrumb-premium a:hover { color: var(--primary); }

    .page-title { font-size: 1.75rem; color: var(--dark); }

    .stats-row {
        background: white;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1.5rem 2rem;
        box-shadow: var(--shadow-sm);
        position: relative;
        overflow: hidden;
    }

    .stats-glow {
        position: absolute;
        top: -30px;
        right: -30px;
        width: 150px;
        height: 150px;
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.06), rgba(16, 185, 129, 0.04));
        border-radius: 50%;
        filter: blur(30px);
        pointer-events: none;
    }

    .stat-card {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem 1.25rem;
        border-radius: var(--radius-sm);
        border: 1px solid var(--gray-lighter);
        background: white;
        transition: var(--transition);
    }

    .stat-card:hover { box-shadow: var(--shadow-sm); }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        flex-shrink: 0;
        box-shadow: var(--shadow-sm);
    }

    .stat-label {
        font-size: 0.72rem;
        font-weight: 600;
        color: var(--gray);
        text-transform: uppercase;
        letter-spacing: 0.04em;
        margin-bottom: 0.15rem;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--dark);
        font-family: 'Plus Jakarta Sans', sans-serif;
        line-height: 1;
    }

    .live-banner {
        background: linear-gradient(135deg, var(--primary-bg), #ede9fe);
        border: 1px solid rgba(37, 99, 235, 0.15);
        border-radius: var(--radius);
        padding: 1.5rem 2rem;
        display: flex;
        align-items: center;
        gap: 1.25rem;
        box-shadow: var(--shadow-sm);
    }

    .live-icon {
        width: 52px;
        height: 52px;
        border-radius: 14px;
        background: linear-gradient(135deg, var(--primary), #7c3aed);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        flex-shrink: 0;
    }

    .section-bar {
        width: 4px;
        height: 24px;
        border-radius: 4px;
        margin-right: 0.75rem;
    }

    .challenge-card {
        background: white;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1.25rem 1.5rem;
        box-shadow: var(--shadow-sm);
        transition: var(--transition);
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    @media (min-width: 576px) {
        .challenge-card {
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
        }
    }

    .challenge-card:hover {
        border-color: rgba(37, 99, 235, 0.2);
        box-shadow: var(--shadow-md);
        transform: translateY(-3px);
    }

    .status-dot {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 0.75rem;
    }

    .status-dot.solved { background: var(--secondary-bg); color: var(--secondary); }
    .status-dot.attempted { background: #fffbeb; color: #d97706; }
    .status-dot.untouched { background: var(--gray-lighter); color: var(--gray); border: 1px solid var(--gray-light); }

    .diff-badge {
        font-size: 0.72rem;
        font-weight: 600;
        padding: 0.15rem 0.55rem;
        border-radius: 4px;
    }

    .diff-easy { background: #f0fdf4; color: #16a34a; }
    .diff-medium { background: #fefce8; color: #ca8a04; }
    .diff-hard { background: #fef2f2; color: #dc2626; }

    .btn-solve {
        background: linear-gradient(135deg, var(--primary), #7c3aed);
        color: white !important;
        border: none;
        font-weight: 600;
        padding: 0.5rem 1.25rem;
        border-radius: 20px;
        box-shadow: 0 3px 10px rgba(37, 99, 235, 0.25);
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        text-decoration: none;
        font-size: 0.82rem;
        white-space: nowrap;
    }

    .btn-solve:hover {
        transform: translateY(-1px);
        box-shadow: 0 5px 15px rgba(37, 99, 235, 0.35);
        color: white !important;
    }

    .btn-quiz-action {
        background: linear-gradient(135deg, var(--secondary), #059669);
        color: white !important;
        border: none;
        font-weight: 600;
        padding: 0.5rem 1.25rem;
        border-radius: 20px;
        box-shadow: 0 3px 10px rgba(16, 185, 129, 0.25);
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        text-decoration: none;
        font-size: 0.82rem;
        white-space: nowrap;
    }

    .btn-quiz-action:hover {
        transform: translateY(-1px);
        box-shadow: 0 5px 15px rgba(16, 185, 129, 0.35);
        color: white !important;
    }

    .btn-closed {
        background: var(--gray-lighter);
        color: var(--gray);
        border: 1px solid var(--gray-light);
        font-weight: 600;
        padding: 0.5rem 1.25rem;
        border-radius: 20px;
        font-size: 0.82rem;
        white-space: nowrap;
        cursor: default;
    }

    .table-premium {
        border-collapse: separate;
        border-spacing: 0;
    }

    .table-premium th {
        background: var(--light);
        color: var(--gray);
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid var(--gray-lighter);
        padding: 0.85rem 1rem;
    }

    .table-premium td {
        padding: 1.15rem 1rem;
        vertical-align: middle;
        border-bottom: 1px solid var(--gray-lighter);
        background: white;
    }

    .table-premium tbody tr:last-child td { border-bottom: none; }
    .table-premium tbody tr { transition: var(--transition); }
    .table-premium tbody tr:hover td { background: var(--light); }

    .rank-badge {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
        color: white;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
    }

    .rank-1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
    .rank-2 { background: linear-gradient(135deg, #e2e8f0, #94a3b8); }
    .rank-3 { background: linear-gradient(135deg, #fcd34d, #d97706); }
    .rank-other { background: transparent; color: var(--gray); box-shadow: none; font-size: 1rem; }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-bg), #ede9fe);
        color: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1rem;
        flex-shrink: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 mt-3">
    <div class="animate-in">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-4 mb-5">
            <div>
                <div class="breadcrumb-premium d-flex align-items-center gap-2 mb-2 flex-wrap">
                    <a href="{% url 'room_detail_student' room.id %}"><i class="fas fa-arrow-left me-1"></i> {{ room.name }}</a>
                    <span class="text-muted">&#8226;</span>
                    {% if is_active %}
                    <span class="fw-medium" style="color: var(--secondary);"><i class="fas fa-circle me-1" style="font-size: 0.4rem; animation: pulse 2s infinite;"></i> Live ending on {{ contest.end_time|date:"M d, Y - H:i A" }}</span>
                    {% else %}
                    <span class="text-muted">Finished on {{ contest.end_time|date:"M d, Y - H:i" }}</span>
                    {% endif %}
                </div>
                <h1 class="page-title mb-1">{{ contest.title }}</h1>
                {% if contest.description %}
                <p class="text-muted mb-0">{{ contest.description }}</p>
                {% endif %}
            </div>
            <div class="d-flex gap-3">
                {% if not is_active %}
                <button class="btn btn-light border fw-medium rounded-3 px-4 shadow-sm" style="display: none;">
                    <i class="fas fa-share-alt me-2"></i> Share Result
                </button>
                <button class="btn btn-primary fw-medium rounded-3 px-4 shadow-sm" style="display: none;">
                    <i class="fas fa-code me-2"></i> View Solutions
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    {% if messages %}
    <div class="mb-4 animate-in delay-1">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show rounded-4 shadow-sm border-0" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if not is_active %}
    <section class="stats-row mb-5 animate-in delay-1">
        <div class="stats-glow"></div>
        <div class="position-relative z-1 row g-3">
            <div class="col-md-3 col-sm-6">
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--primary-bg); color: var(--primary);">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div>
                        <div class="stat-label">Contest Status</div>
                        <div class="stat-value" style="font-size: 1.2rem;">Closed</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--secondary-bg); color: var(--secondary);">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div>
                        <div class="stat-label">Items Listed</div>
                        <div class="stat-value">{{ content_items|length }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-sm-12">
                <div class="p-3 border rounded-3 d-flex align-items-center justify-content-center h-100" style="background: var(--light);">
                    <p class="text-muted mb-0 small"><i class="fas fa-info-circle me-1"></i> Real-time rank and specific scores are published by the admin contextually. This view is read-only.</p>
                </div>
            </div>
        </div>
    </section>
    {% else %}
    <div class="live-banner mb-5 animate-in delay-1">
        <div class="live-icon"><i class="fas fa-satellite-dish" style="animation: pulse 2s infinite;"></i></div>
        <div>
            <h5 class="fw-bold mb-1" style="color: var(--dark);">Contest is Live</h5>
            <p class="mb-0 small text-muted">Read carefully and submit your solutions before the timer runs out. Good luck!</p>
        </div>
    </div>
    {% endif %}

    <div class="animate-in delay-2">
        <div class="d-flex align-items-center justify-content-between mb-4">
            <div class="d-flex align-items-center">
                <div class="section-bar" style="background: var(--primary);"></div>
                <h4 class="mb-0" style="color: var(--dark); font-size: 1.1rem;">Challenge <span class="text-gradient">List</span></h4>
            </div>
        </div>

        <div class="d-flex flex-column gap-3">
            {% for item in content_items %}
            <div class="challenge-card">
                <div class="d-flex gap-3 align-items-start">
                    {% if item.type == 'PROBLEM' %}
                        {% if item.status == 'SOLVED' %}
                        <div class="status-dot solved"><i class="fas fa-check"></i></div>
                        {% elif item.status == 'UNSOLVED_ATTEMPTED' %}
                        <div class="status-dot attempted"><i class="fas fa-times"></i></div>
                        {% else %}
                        <div class="status-dot untouched"><i class="fas fa-minus"></i></div>
                        {% endif %}
                    {% else %}
                        {% if item.status == 'COMPLETED' %}
                        <div class="status-dot solved"><i class="fas fa-check"></i></div>
                        {% else %}
                        <div class="status-dot untouched"><i class="fas fa-minus"></i></div>
                        {% endif %}
                    {% endif %}

                    <div>
                        <h5 class="fw-bold mb-2" style="color: var(--dark); font-size: 0.95rem;">{{ item.sequence }}. {{ item.title }}</h5>
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            {% if item.type == 'PROBLEM' %}
                                {% if item.difficulty == 'Easy' %}
                                <span class="diff-badge diff-easy">Easy</span>
                                {% elif item.difficulty == 'Medium' %}
                                <span class="diff-badge diff-medium">Medium</span>
                                {% elif item.difficulty == 'Hard' %}
                                <span class="diff-badge diff-hard">Hard</span>
                                {% else %}
                                <span class="diff-badge" style="background: var(--gray-lighter); color: var(--gray);">{{ item.difficulty|default:"General" }}</span>
                                {% endif %}
                                <span class="small text-muted border-start ps-2 border-2">Programming Problem</span>
                            {% else %}
                                <span class="diff-badge" style="background: var(--primary-bg); color: var(--primary);">Quiz</span>
                                <span class="small text-muted border-start ps-2 border-2">Multiple Choice</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="d-flex align-items-center justify-content-between justify-content-sm-end gap-4 ps-5 ps-sm-0 mt-2 mt-sm-0 w-100" style="max-width: 300px;">
                    <div class="text-end d-none d-sm-block w-100">
                        {% if item.type == 'PROBLEM' %}
                            {% if item.status == 'SOLVED' %}
                            <span class="d-block fw-bold small" style="color: var(--secondary);">Solved</span>
                            {% elif item.status == 'UNSOLVED_ATTEMPTED' %}
                            <span class="d-block fw-bold small" style="color: var(--danger);">Attempted</span>
                            {% else %}
                            <span class="d-block fw-medium text-muted small">Not Attempted</span>
                            {% endif %}
                        {% else %}
                            {% if item.status == 'COMPLETED' %}
                            <span class="d-block fw-bold small" style="color: var(--secondary);">Score: {{ item.score|floatformat:1 }}%</span>
                            {% else %}
                            <span class="d-block fw-medium text-muted small">Not Started</span>
                            {% endif %}
                        {% endif %}
                    </div>

                    {% if is_active %}
                        {% if item.type == 'PROBLEM' %}
                        <a href="{% url 'contest_problem_solver' room_id=room.id contest_id=contest.id content_id=item.content_id %}" class="btn-solve">Solve Concept</a>
                        {% else %}
                        <a href="{% url 'contest_quiz_view' room_id=room.id contest_id=contest.id content_id=item.content_id %}" class="btn-quiz-action">Take Quiz</a>
                        {% endif %}
                    {% else %}
                    <span class="btn-closed">Closed</span>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="text-center py-5 border rounded-4 shadow-sm" style="background: white;">
                <div class="d-inline-flex align-items-center justify-content-center mb-3 rounded-circle" style="width: 72px; height: 72px; background: var(--gray-lighter);">
                    <i class="fas fa-folder-open fa-2x" style="color: var(--gray);"></i>
                </div>
                <h5 class="fw-bold" style="color: var(--dark);">No challenges yet</h5>
                <p class="text-muted mb-0">The instructor has not added any challenges to this contest.</p>
            </div>
            {% endfor %}
        </div>
    </div>

    {% if leaderboard %}
    <div class="mt-5 mb-5 animate-in delay-3">
        <div class="d-flex align-items-center justify-content-between mb-4">
            <div class="d-flex align-items-center">
                <div class="section-bar" style="background: #f59e0b;"></div>
                <h4 class="mb-0" style="color: var(--dark); font-size: 1.1rem;"><i class="fas fa-trophy me-2" style="color: #f59e0b;"></i> Final Leaderboard</h4>
            </div>
            <span class="badge px-3 py-2 rounded-pill shadow-sm" style="background: var(--gray-lighter); color: var(--gray); font-size: 0.72rem; font-weight: 600;">Ranked by Total Points</span>
        </div>
        <div class="rounded-4 overflow-hidden shadow-sm border" style="background: white;">
            <div class="table-responsive">
                <table class="table table-premium align-middle mb-0 w-100">
                    <thead>
                        <tr>
                            <th class="ps-4 text-center" style="width: 80px;">Rank</th>
                            <th>Student Profile</th>
                            <th class="text-center">Coding Record</th>
                            <th class="text-center">Quiz Intel</th>
                            <th class="text-end pe-4">Total Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in leaderboard %}
                        <tr>
                            <td class="ps-4 text-center">
                                <div class="d-flex justify-content-center">
                                    {% if forloop.counter == 1 and entry.points > 0 %}
                                    <div class="rank-badge rank-1"><i class="fas fa-crown small"></i></div>
                                    {% elif forloop.counter == 2 and entry.points > 0 %}
                                    <div class="rank-badge rank-2">2</div>
                                    {% elif forloop.counter == 3 and entry.points > 0 %}
                                    <div class="rank-badge rank-3">3</div>
                                    {% else %}
                                    <div class="rank-badge rank-other">{{ forloop.counter }}</div>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center gap-3">
                                    <div class="user-avatar">{{ entry.email|make_list|first|upper }}</div>
                                    <div class="d-flex flex-column">
                                        <span class="{% if entry.points > 0 %}fw-bold{% else %}fw-medium{% endif %}" style="color: var(--dark);">
                                            {% if entry.email == request.user.email %}{{ entry.email }} (You){% else %}{{ entry.email }}{% endif %}
                                        </span>
                                        {% if entry.points == 0 %}
                                        <span class="badge mt-1" style="width: fit-content; font-size: 0.62rem; background: var(--gray-lighter); color: var(--gray);">Not Started</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="d-inline-flex align-items-center justify-content-center px-3 py-1 rounded-pill gap-2" style="background: var(--gray-lighter); border: 1px solid var(--gray-light);">
                                    {% if entry.problems_solved > 0 %}
                                    <i class="fas fa-check-circle small" style="color: var(--secondary);"></i>
                                    <span class="fw-bold" style="color: var(--dark);">{{ entry.problems_solved }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="text-center">
                                <span class="badge px-3 py-2 rounded-pill font-monospace {% if entry.quiz_score > 0 %}{% else %}{% endif %}" style="font-size: 0.85rem; {% if entry.quiz_score > 0 %}background: var(--primary-bg); color: var(--primary); border: 1px solid rgba(37,99,235,0.15);{% else %}background: var(--gray-lighter); color: var(--gray); border: 1px solid var(--gray-light);{% endif %}">
                                    {{ entry.quiz_score|floatformat:1 }}%
                                </span>
                            </td>
                            <td class="text-end pe-4">
                                <span class="fw-bold {% if entry.points > 0 %}{% else %}opacity-50{% endif %}" style="font-size: 1.25rem; font-family: 'Plus Jakarta Sans', sans-serif; color: {% if entry.points > 0 %}var(--primary){% else %}var(--gray){% endif %};">
                                    {{ entry.points|floatformat:2 }}
                                </span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-3" style="width: 60px; height: 60px; background: var(--gray-lighter);">
                                    <i class="fas fa-user-times" style="color: var(--gray);"></i>
                                </div>
                                <h6 class="fw-bold" style="color: var(--dark);">No Activity Detected</h6>
                                <p class="text-muted small mb-0">No participants played this contest.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
